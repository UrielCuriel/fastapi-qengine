---
title: Configuración Avanzada
description: Personaliza el pipeline (QEngineConfig) y la política de seguridad (SecurityPolicy).
navigation:
  title: Advanced Config
  icon: i-lucide-settings
---

::u-card
Los engines explícitos (p. ej., `BeanieQueryEngine`) reutilizan el pipeline del core para parsear, normalizar, validar, construir y optimizar un `FilterAST`.

Puedes controlar este pipeline con `QEngineConfig` y restringir el uso mediante `SecurityPolicy`.
::

## Uso rápido con un Engine

```python [dependency.py]
from fastapi_qengine import create_qe_dependency
from fastapi_qengine.core import QEngineConfig, SecurityPolicy
from fastapi_qengine.backends.beanie import BeanieQueryEngine

# 1) Config global (puedes crearla una vez y reutilizarla)
config = QEngineConfig(
    debug=True,  # errores detallados durante desarrollo
)

# 2) Política de seguridad estricta
policy = SecurityPolicy(
    max_depth=3,
    allowed_fields=["name", "category", "price", "in_stock"],
    blocked_fields=["password", "secret"],
)

# 3) Engine explícito de tu backend
engine = BeanieQueryEngine(Product)

# 4) Dependencia FastAPI con config/policy
qe_dep = create_qe_dependency(engine, config=config, security_policy=policy)
```

En tus rutas: `query, projection_model, sort = await qe_dep(...)` (inyectado por FastAPI con `Depends`).

## Ajustes comunes (recetas)

::steps
### Limitar profundidad y tamaño de arreglos
Evita explosiones combinatorias en `$and/$or` y proteje al backend:

```python
SecurityPolicy(max_depth=3, max_array_size=50)
```

### Whitelist/Blacklist de campos
Controla qué campos se pueden consultar/ordenar/proyectar:

```python
SecurityPolicy(allowed_fields=["name", "category"], blocked_fields=["internal_notes"]) 
```

### Restringir operadores
Permite únicamente operadores de comparación específicos:

```python
from fastapi_qengine.core import ComparisonOperator

SecurityPolicy(allowed_operators=[ComparisonOperator.EQ, ComparisonOperator.IN])
```

### Parser estricto y operadores case-sensitive
Haz que el parser rechace claves desconocidas y respete mayúsculas:

```python
from fastapi_qengine.core import QEngineConfig, ParserConfig

QEngineConfig(parser=ParserConfig(strict_mode=True, case_sensitive_operators=True))
```

### Optimización del AST
Desactiva optimizaciones si necesitas depuración exacta del árbol:

```python
from fastapi_qengine.core import QEngineConfig, OptimizerConfig

QEngineConfig(optimizer=OptimizerConfig(enabled=False))
```
::

## Pipeline sin FastAPI

Puedes reutilizar el pipeline directamente para pruebas o scripts:

```python
from fastapi_qengine import process_filter_to_ast
from fastapi_qengine.backends.beanie import BeanieQueryCompiler

ast = process_filter_to_ast({
    "where": {"price": {"$gte": 10, "$lte": 100}},
    "order": "-price",
    "fields": {"name": 1, "price": 1},
}, config=config, security_policy=policy)

mongo = BeanieQueryCompiler().compile(ast)
```

## Notas

::u-alert{type="info"}
- `create_qe_dependency` acepta `config` y `security_policy`. Si no las pasas, utiliza `default_config`.
- `backend_settings` dentro de `QEngineConfig` permite definir claves por backend: los engines pueden leerlas si lo requieren.
::

